{%- comment -%}
  ----------------------------------------------------------------------------------------------------------------------
  PRODUCT REVIEWS BREAKDOWN
  ----------------------------------------------------------------------------------------------------------------------

  This component displays a detailed breakdown of product reviews with star ratings distribution.

  ********************************************
  Supported variables
  ********************************************

  * product: the product from which reviews are extracted
  * reviews_url: optional URL to full reviews page
  * show_empty: if set to true, shows empty state
{%- endcomment -%}

{%- liquid
  if product.metafields.reviews.rating.value != blank
    assign rating_value = product.metafields.reviews.rating.value.rating | round: 1
    assign rating_count = product.metafields.reviews.rating_count.value
    assign rating_max = product.metafields.reviews.rating.value.scale_max

    # Get rating distribution from metafields if available
    # This assumes metafields structure like reviews.rating_distribution
    assign rating_5 = product.metafields.reviews.rating_distribution.value.5 | default: 0
    assign rating_4 = product.metafields.reviews.rating_distribution.value.4 | default: 0
    assign rating_3 = product.metafields.reviews.rating_distribution.value.3 | default: 0
    assign rating_2 = product.metafields.reviews.rating_distribution.value.2 | default: 0
    assign rating_1 = product.metafields.reviews.rating_distribution.value.1 | default: 0

    # If distribution not available, use block settings (customizable)
    if rating_5 == 0 and rating_4 == 0 and rating_3 == 0 and rating_2 == 0 and rating_1 == 0
      assign rating_5 = block.settings.rating_5 | default: 0
      assign rating_4 = block.settings.rating_4 | default: 0
      assign rating_3 = block.settings.rating_3 | default: 0
      assign rating_2 = block.settings.rating_2 | default: 0
      assign rating_1 = block.settings.rating_1 | default: 0
    endif

    assign written_reviews_count = product.metafields.reviews.written_reviews_count.value | default: block.settings.written_reviews_count | default: 0
  elsif show_empty
    assign rating_value = 0.0
    assign rating_count = 0
    assign rating_max = 5
    assign rating_5 = 0
    assign rating_4 = 0
    assign rating_3 = 0
    assign rating_2 = 0
    assign rating_1 = 0
    assign written_reviews_count = 0
  else
    assign hide_reviews = true
  endif
-%}

{%- unless hide_reviews -%}
  <div id="product-reviews" class="product-reviews v-stack gap-4" {{ block.shopify_attributes }}>
    {%- if rating_count > 0 -%}
      <div class="product-reviews__overall v-stack gap-2">
        <div class="product-reviews__rating-display h-stack gap-3 align-center">
          <span class="product-reviews__rating-value h4">{{ rating_value }}</span>
          <div
            class="product-reviews__stars"
            role="img"
            aria-label="{{ 'general.rating.info' | t: rating_value: rating_value, rating_max: rating_max }}"
          >
            {%- liquid
              assign rating_int = rating_value | floor
              assign rating_decimal = rating_value | minus: rating_int
              assign next_star = rating_int | plus: 1
            -%}
            {%- for i in (1..rating_max) -%}
              {%- if i <= rating_int -%}
                {%- render 'icon' with 'star-rating' -%}
              {%- elsif i == next_star and rating_decimal >= 0.3 -%}
                {%- render 'icon' with 'star-rating-half' -%}
              {%- else -%}
                {%- render 'icon' with 'star-rating-empty' -%}
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
        <p class="text-sm text-subdued">
          {{ 'product.reviews.based_on' | t: votes: rating_count, reviews: written_reviews_count }}
        </p>
      </div>

      <div class="product-reviews__breakdown v-stack gap-2">
        {%- for i in (5..1) -%}
          {%- liquid
            case i
              when 5
                assign count = rating_5
              when 4
                assign count = rating_4
              when 3
                assign count = rating_3
              when 2
                assign count = rating_2
              when 1
                assign count = rating_1
            endcase

            if rating_count > 0
              assign percentage = count | times: 100.0 | divided_by: rating_count
            else
              assign percentage = 0
            endif
          -%}

          <div class="product-reviews__rating-row h-stack gap-3 align-center">
            <span class="product-reviews__star-label text-sm">
              {{- i }}
              {{ 'product.reviews.stars' | t -}}
            </span>
            <div class="product-reviews__bar-container" style="flex: 1;">
              <div class="product-reviews__bar" style="width: {{ percentage }}%;"></div>
            </div>
            <span class="product-reviews__count text-sm text-subdued">
              {{- count }}
              {{ 'product.reviews.votes' | t -}}
            </span>
          </div>
        {%- endfor -%}
      </div>

      {%- if reviews_url != blank -%}
        <div class="product-reviews__link">
          <a href="{{ reviews_url }}" class="link-faded text-sm">
            {{ 'product.reviews.view_all' | t }}
            {%- render 'icon' with 'chevron-right', width: 12 -%}
          </a>
        </div>
      {%- endif -%}
    {%- else -%}
      <p class="text-sm text-subdued">{{ 'product.reviews.no_reviews' | t }}</p>
    {%- endif -%}
  </div>
{%- endunless -%}
