{%- comment -%}
  ----------------------------------------------------------------------------------------------------------------------
  PRODUCT CARD COMPONENT - CRO OPTIMIZED
  ----------------------------------------------------------------------------------------------------------------------

  This component is used in collection and featured collection to render a single product as a card

  ********************************************
  Supported variables
  ********************************************

  * product: the product to render
  * stacked: define if the product is stacked or not on mobile
  * reveal: if set to true, the card will be revealed on scroll through animation
  * position: the position of the card in the list. If specified, the theme will eagerly load the first 3 cards images
  * show_badges: show or not the badges (default to true if nothing is set).
  * show_rating: show or not the rating. If nothing is set, the theme uses the default product card setting
  * show_vendor: show or not the vendor. If nothing is set, the theme uses the default product card setting
  * show_quick_buy: show or not the quick buy (which open a modal if the product contains more than 1 choice)
  * show_secondary_image: show or not the secondary media on hover. If nothing is set, the theme uses the default product card setting
  * show_swatches: show or not the swatches. The swatch type is inferred from setting, and will default to true if nothing is set.
  * hide_product_information: if set to true, all content (vendor, badge, title...) are not rendered, to create image-based grid
  * quick_buy_context: a unique text to dissociate quick buy if the same product is embedded multiple times
{%- endcomment -%}

{%- liquid
  if hide_product_information
    assign show_badges = false
    assign show_rating = false
    assign show_vendor = false
    assign show_title = false
    assign show_prices = false
    assign show_swatches = false
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
  else
    assign show_badges = show_badges | default: true, allow_false: true
    assign show_rating = show_rating | default: settings.show_product_rating, allow_false: true
    assign show_vendor = show_vendor | default: settings.show_vendor, allow_false: true
    assign show_quick_buy = show_quick_buy | default: settings.show_quick_buy, allow_false: true
    assign show_title = true
    assign show_prices = true
    assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image, allow_false: true
    assign show_swatches = show_swatches | default: true, allow_false: true
  endif

  assign inventory_quantity = 0
  for variant in product.variants
    assign inventory_quantity = inventory_quantity | plus: variant.inventory_quantity
  endfor
-%}

<product-card
  class="product-card"
  {% if reveal %}
    reveal-on-scroll="true"
  {% endif %}
  handle="{{ product.handle | escape }}"
>
  {%- if product.media.size > 0 -%}
    <div class="product-card__figure">
      <div class="product-card__badge-container">
        {%- if product.available -%}
          {%- if inventory_quantity > 0 and inventory_quantity <= 10 -%}
            <span class="product-card__badge product-card__badge--limited"> Only {{ inventory_quantity }} left </span>
          {%- else -%}
            <span class="product-card__badge product-card__badge--stock">âœ“ In Stock</span>
          {%- endif -%}
        {%- endif -%}

        {%- if product.tags contains 'new' -%}
          <span class="product-card__badge product-card__badge--new">New</span>
        {%- endif -%}

        {%- if show_badges -%}
          {%- render 'product-badges', product: product, vertical: false, context: 'card' -%}
        {%- endif -%}
      </div>
      {%- capture quick_buy_id -%}product-quick-buy-{{ section.id }}-{{ block.id }}-{{ quick_buy_context }}-{{ product.id }}{%- endcapture -%}

      <a href="{{ product.url }}" class="product-card__media" draggable="false" data-instant>
        {%- capture sizes -%}
          {%- if stacked -%}
            (max-width: 699px) calc(100vw / {{ section.settings.products_per_row_mobile }}), (max-width: 999px) calc(100vw / {{ 3 | at_most: section.settings.products_per_row_desktop | default: 3 }} - 64px), calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
          {%- else -%}
            (max-width: 699px) 74vw, (max-width: 999px) 38vw, calc((100vw - 96px) / {{ section.settings.products_per_row_desktop | default: 3 }} - (24px / {{ section.settings.products_per_row_desktop | default: 3 }} * {{ section.settings.products_per_row_desktop | default: 3 | minus: 1 }}))
          {%- endif -%}
        {%- endcapture -%}

        {%- liquid
          assign main_media_loading_strategy = null

          if section.index > 3 or position > 3
            assign main_media_loading_strategy = 'lazy'
          endif
        -%}

        {%- capture main_image_classes -%}product-card__image product-card__image--primary aspect-[3/4]{%- endcapture -%}
        {{-
          product.featured_media
          | image_url: width: product.featured_media.width
          | image_tag:
            loading: main_media_loading_strategy,
            sizes: sizes,
            widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800',
            draggable: 'false',
            class: main_image_classes
        -}}

        {%- liquid
          if show_secondary_image and product.media.size > 1
            assign next_media = product.media[product.featured_media.position] | default: product.media[1]

            if next_media != blank
              echo next_media | image_url: width: next_media.width | image_tag: class: 'product-card__image product-card__image--secondary', loading: 'lazy', fetchpriority: 'low', sizes: sizes, widths: '200,300,400,500,600,700,800,1000,1200,1400,1600,1800', draggable: 'false'
            endif
          endif
        -%}
      </a>

      <button
        class="product-card__quick-view-btn"
        aria-label="Quick view"
        data-product-handle="{{ product.handle }}"
        aria-controls="{{ quick_buy_id }}"
      >
        Quick View
      </button>

      <quick-buy-modal
        handle="{{ product.handle }}?variant={{ product.selected_or_first_available_variant.id }}"
        class="quick-buy-modal modal"
        id="{{ quick_buy_id }}"
      >
      </quick-buy-modal>
    </div>
  {%- endif -%}

  <div class="product-card__content">
    {%- if show_vendor and product.vendor != blank -%}
      <div class="product-card__vendor">
        {{ product.vendor }}
      </div>
    {%- endif -%}

    {%- if show_title -%}
      <a href="{{ product.url }}" class="product-card__title" data-instant>
        {{- product.title -}}
      </a>
    {%- endif -%}

    {%- if show_rating -%}
      <div class="product-card__rating-wrapper" data-show-empty="{{ settings.show_product_rating_if_empty }}">
        {%- render 'product-rating',
          product: product,
          context: 'card',
          show_empty: settings.show_product_rating_if_empty,
          mode: settings.product_rating_mode
        -%}
      </div>
    {%- endif -%}

    {%- if product.description != blank and settings.show_product_description_on_card -%}
      <p class="product-card__description">
        {{ product.description | strip_html | truncate: 100 }}
      </p>
    {%- endif -%}

    {%- if show_prices -%}
      <div class="product-card__price-section">
        <span class="product-card__price-current">
          {{ product.price | money }}
        </span>
        {%- if product.compare_at_price > product.price -%}
          <span class="product-card__price-original">
            {{ product.compare_at_price | money }}
          </span>
          {%- assign discount_percentage = product.compare_at_price
            | minus: product.price
            | times: 100.0
            | divided_by: product.compare_at_price
            | round
          -%}
          <span class="product-card__discount-badge">-{{ discount_percentage }}%</span>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment -%} Compact Layout: Stock Status {%- endcomment -%}
    <div class="product-card__compact-info">
      {% comment %}
        {%- if product.available -%}
          <div class="product-card__compact-stock">
            <span class="product-card__compact-stock-dot"></span>
            {%- if inventory_quantity > 0 and inventory_quantity <= 10 -%}
              <span>{{ 'product.inventory.low_stock_with_quantity_count' | t: count: inventory_quantity }}</span>
            {%- else -%}
              <span>{{ 'product.inventory.in_stock' | t }}</span>
            {%- endif -%}
          </div>
        {%- else -%}
          <div class="product-card__compact-stock product-card__compact-stock--out">
            <span>{{ 'product.inventory.out_of_stock' | t }}</span>
          </div>
        {%- endif -%}
      {% endcomment %}

      {%- comment -%} Compact Trust Badges {%- endcomment -%}
      <div class="product-card__compact-badges">
        <span class="product-card__compact-badge">
          <svg viewBox="0 0 20 20" fill="currentColor" width="14" height="14">
            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
          </svg>
          {{ 'product.general.free_shipping' | t | default: 'Free Shipping' }}
        </span>
        <span class="product-card__compact-badge">
          <svg viewBox="0 0 20 20" fill="currentColor" width="14" height="14">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          {{ 'product.general.return_policy' | t | default: '30-Day Return' }}
        </span>
      </div>
    </div>

    <div class="product-card__cta">
      {%- if product.available -%}
        {%- if product.variants.size == 1 and product.selling_plan_groups.size == 0 -%}
          <product-form class="product-card__cta-form">
            {%- form 'product', product -%}
              <input type="hidden" name="on_success" value="force_open_drawer">
              <input type="hidden" name="quantity" value="1">
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              <button type="submit" class="product-card__cta-btn">
                {{ 'product.general.add_to_cart_button' | t }}
              </button>
              {% render 'wishlisthero-collection-product' with product: product %}
            {%- endform -%}
          </product-form>
        {%- else -%}
          <button
            type="button"
            class="product-card__cta-btn"
            aria-controls="{{ quick_buy_id }}"
            data-quick-buy-trigger="{{ quick_buy_id }}"
          >
            {{ 'product.general.add_to_cart_button' | t }}
          </button>
        {%- endif -%}
      {%- else -%}
        <button type="button" class="product-card__cta-btn product-card__cta-btn--sold-out" disabled>
          {{ 'product.general.sold_out_button' | t }}
        </button>
      {%- endif -%}

      {%- comment -%} View Details Button - Shown in Compact Layout {%- endcomment -%}
      <a href="{{ product.url }}" class="product-card__view-details-btn" data-instant>
        {{ 'product.general.view_details' | t }}
      </a>
    </div>

    <div class="product-card__trust-signals">
      <div class="product-card__trust-item">
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
          <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
        </svg>
        <span>Free Shipping</span>
      </div>
      <div class="product-card__trust-item">
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span>30-Day Return</span>
      </div>
    </div>

    {%- if show_swatches and settings.product_color_display != 'hide' -%}
      {%- liquid
        assign matched_product_option = null
        assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ','

        for color_label in color_label_list
          if product.options_by_name[color_label] != blank
            assign matched_product_option = product.options_by_name[color_label]
            break
          endif
        endfor

        if matched_product_option == blank
          for product_option in product.options_with_values
            assign values_with_swatch = product_option.values | where: 'swatch'

            if values_with_swatch.size > 0
              assign matched_product_option = product_option
              break
            endif
          endfor
        endif
      -%}

      {%- if matched_product_option != blank -%}
        {%- case settings.product_color_display -%}
          {%- when 'count' -%}
            <p class="product-card__color-count">
              {{- 'product.general.available_colors_count' | t: count: matched_product_option.values.size -}}
            </p>

          {%- when 'swatch' -%}
            <fieldset class="product-card__swatches">
              <legend class="sr-only">{{ matched_product_option.name }}</legend>

              {%- capture param_name -%}swatch-{{ quick_buy_context }}-{{ section.id }}-{{ block.id }}-{{ product.id }}-{{ matched_product_option.position }}{%- endcapture -%}

              {%- liquid
                for option_value in matched_product_option.values
                  render 'option-value', type: 'swatch', option_value: option_value, param_name: param_name, option_position: matched_product_option.position, output_variant_media: true, size: 'sm'
                endfor
              -%}
            </fieldset>
        {%- endcase -%}
      {%- endif -%}
    {%- endif -%}
  </div>
</product-card>

{{- 'product-card-custom.css' | asset_url | stylesheet_tag -}}

<script src="{{ 'product-card.js' | asset_url }}" defer></script>
