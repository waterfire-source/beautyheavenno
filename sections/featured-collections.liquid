{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
FEATURED COLLECTIONS SECTION
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

{{ 'featured-collections.css' | asset_url | stylesheet_tag }}

{%- if section.blocks.size > 0 -%}
  <div class="featured-collections-section">
    <div class="container">
      {%- comment -%} Header {%- endcomment -%}
      <div class="featured-collections-header">
        {%- if section.settings.category_button_text != blank -%}
          <div class="featured-collections-category-button">
            {{ section.settings.category_button_text }}
          </div>
        {%- endif -%}

        {%- if section.settings.heading != blank -%}
          <h2 class="featured-collections-heading">{{ section.settings.heading }}</h2>
        {%- endif -%}
      </div>

      {%- comment -%} Collection Cards Grid {%- endcomment -%}
      <div class="featured-collections-wrapper">
        <div class="featured-collections-grid">
          {%- for block in section.blocks -%}
            <div class="featured-collection-card" {{ block.shopify_attributes }}>
              <div class="featured-collection-card__image-wrapper">
                {%- if block.settings.desktop_image != blank -%}
                  <picture>
                    {%- if block.settings.mobile_image != blank -%}
                      <source
                        media="(max-width: 699px)"
                        srcset="{{ block.settings.mobile_image | image_url: width: 800 }} 800w, {{ block.settings.mobile_image | image_url: width: 1000 }} 1000w"
                        width="{{ block.settings.mobile_image.width }}"
                        height="{{ block.settings.mobile_image.height }}"
                      >
                    {%- endif -%}

                    {{- block.settings.desktop_image | image_url: width: block.settings.desktop_image.width | image_tag: loading: 'lazy', sizes: '100vw', widths: '800,1200,1600,2000', class: 'featured-collection-card__image' -}}
                  </picture>
                {%- elsif block.settings.collection.featured_image != blank -%}
                  <picture>
                    {%- if block.settings.mobile_image != blank -%}
                      <source
                        media="(max-width: 699px)"
                        srcset="{{ block.settings.mobile_image | image_url: width: 800 }} 800w, {{ block.settings.mobile_image | image_url: width: 1000 }} 1000w"
                        width="{{ block.settings.mobile_image.width }}"
                        height="{{ block.settings.mobile_image.height }}"
                      >
                    {%- endif -%}

                    {{- block.settings.collection.featured_image | image_url: width: block.settings.collection.featured_image.width | image_tag: loading: 'lazy', sizes: '100vw', widths: '800,1200,1600,2000', class: 'featured-collection-card__image' -}}
                  </picture>
                {%- else -%}
                  {%- capture placeholder_image -%}{%- cycle 'collection-1', 'collection-2', 'collection-3', 'collection-4' -%}{%- endcapture -%}
                  {{- placeholder_image | placeholder_svg_tag: 'featured-collection-card__image placeholder' | replace: '<svg', '<svg preserveAspectRatio="xMinYMin slice"' -}}
                {%- endif -%}

                {%- comment -%} Content Overlay {%- endcomment -%}
                <div class="featured-collection-card__content">
                  {%- if block.settings.tagline != blank -%}
                    <p class="featured-collection-card__tagline">{{ block.settings.tagline }}</p>
                  {%- endif -%}

                  {%- if block.settings.title != blank -%}
                    <h3 class="featured-collection-card__title">{{ block.settings.title }}</h3>
                  {%- elsif block.settings.collection.title != blank -%}
                    <h3 class="featured-collection-card__title">{{ block.settings.collection.title }}</h3>
                  {%- endif -%}

                  {%- if block.settings.button_text != blank -%}
                    <div class="featured-collection-card__button">
                      <span>{{ block.settings.button_text }}</span>
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3.33334 8H12.6667" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 3.33325L12.6667 7.99992L8 12.6666" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endfor -%}
        </div>

        {%- comment -%} Mobile Pagination Dots {%- endcomment -%}
        {%- if section.blocks.size > 1 -%}
          <div class="featured-collections-pagination">
            {%- for block in section.blocks -%}
              <button class="featured-collections-dot {% if forloop.first %}active{% endif %}" aria-label="Go to slide {{ forloop.index }}" data-slide="{{ forloop.index0 }}"></button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
{%- endif -%}

<script>
  (function() {
    const sectionId = 'shopify-section-{{ section.id }}';
    const grid = document.querySelector(`#${sectionId} .featured-collections-grid`);
    const dots = document.querySelectorAll(`#${sectionId} .featured-collections-dot`);

    if (!grid || dots.length === 0) return;

    // Only run on mobile
    if (window.innerWidth > 699) return;

    function updateActiveDot() {
      if (!grid) return;

      const cards = grid.querySelectorAll('.featured-collection-card');
      if (cards.length === 0) return;

      const scrollLeft = grid.scrollLeft;
      const cardWidth = cards[0].offsetWidth;
      const gap = 16; // 1rem gap
      const scrollPosition = scrollLeft + (cardWidth / 2);

      // Find which card is currently in view
      let activeIndex = 0;
      cards.forEach((card, index) => {
        const cardLeft = index * (cardWidth + gap);
        const cardRight = cardLeft + cardWidth;

        if (scrollPosition >= cardLeft && scrollPosition < cardRight) {
          activeIndex = index;
        }
      });

      // Update dots
      dots.forEach((dot, index) => {
        if (index === activeIndex) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    }

    // Handle scroll events
    let scrollTimeout;
    grid.addEventListener('scroll', function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateActiveDot, 100);
    });

    // Handle dot clicks
    dots.forEach((dot, index) => {
      dot.addEventListener('click', function() {
        const cards = grid.querySelectorAll('.featured-collection-card');
        if (cards[index]) {
          const cardWidth = cards[0].offsetWidth;
          const gap = 16;
          const scrollTo = index * (cardWidth + gap);

          grid.scrollTo({
            left: scrollTo,
            behavior: 'smooth'
          });

          // Update active dot immediately
          dots.forEach(d => d.classList.remove('active'));
          dot.classList.add('active');
        }
      });
    });

    // Initial update
    updateActiveDot();

    // Handle window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        if (window.innerWidth <= 699) {
          updateActiveDot();
        }
      }, 250);
    });
  })();
</script>

{% schema %}
{
  "name": "Featured Collections",
  "class": "shopify-section--featured-collections",
  "tag": "section",
  "max_blocks": 4,
  "settings": [
    {
      "type": "text",
      "id": "category_button_text",
      "label": "Category Button Text",
      "default": "SHOP BY CATEGORY"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Collections"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "image_picker",
          "id": "desktop_image",
          "label": "Desktop Image",
          "info": "Recommended size: 1200x800px"
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Mobile Image",
          "info": "Recommended size: 800x1000px"
        },
        {
          "type": "text",
          "id": "tagline",
          "label": "Tagline",
          "default": "Glow from within"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Collection Title",
          "info": "Leave blank to use collection name"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "Shop Collection"
        },
      ]
    }
  ],
  "presets": [
    {
      "name": "Featured Collections",
      "blocks": [
        {
          "type": "collection",
          "settings": {
            "tagline": "Glow from within",
            "title": "Skincare",
            "button_text": "Shop Collection"
          }
        },
        {
          "type": "collection",
          "settings": {
            "tagline": "Healthy, beautiful hair",
            "title": "Haircare",
            "button_text": "Shop Collection"
          }
        },
        {
          "type": "collection",
          "settings": {
            "tagline": "Nourish your skin",
            "title": "Bodycare",
            "button_text": "Shop Collection"
          }
        },
        {
          "type": "collection",
          "settings": {
            "tagline": "Perfect presents",
            "title": "Gift Sets",
            "button_text": "Shop Collection"
          }
        }
      ]
    }
  ]
}
{% endschema %}
